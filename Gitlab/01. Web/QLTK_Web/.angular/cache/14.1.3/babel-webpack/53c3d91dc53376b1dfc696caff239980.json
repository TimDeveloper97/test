{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { DxTreeListComponent } from 'devextreme-angular';\nimport { BlockUI } from 'ng-block-ui';\nimport { BroadcastEventListener } from 'src/app/signalr/broadcast.event.listener';\nimport { ShowEditContenComponent } from '../show-edit-conten/show-edit-conten.component';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/shared\";\nimport * as i2 from \"@ng-bootstrap/ng-bootstrap\";\nimport * as i3 from \"src/app/signalR/signal-r.service\";\nimport * as i4 from \"../service/solution.service\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@angular/forms\";\nimport * as i7 from \"ngx-perfect-scrollbar\";\nimport * as i8 from \"devextreme-angular/ui/nested\";\nimport * as i9 from \"devextreme-angular/ui/tree-list\";\n\nfunction SolutionChooseFileUploadModalComponent_tr_30_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r6 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"tr\", 28);\n    i0.ɵɵlistener(\"click\", function SolutionChooseFileUploadModalComponent_tr_30_Template_tr_click_0_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r6);\n      const row_r3 = restoredCtx.$implicit;\n      const ctx_r5 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r5.chooseFile(row_r3.FilePath));\n    });\n    i0.ɵɵelementStart(1, \"td\", 29);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd()();\n  }\n\n  if (rf & 2) {\n    const row_r3 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(row_r3.FileName);\n  }\n}\n\nexport class SolutionChooseFileUploadModalComponent {\n  constructor(config, modalService, signalRService, activeModal, messageService, solutionService, constants) {\n    this.config = config;\n    this.modalService = modalService;\n    this.signalRService = signalRService;\n    this.activeModal = activeModal;\n    this.messageService = messageService;\n    this.solutionService = solutionService;\n    this.constants = constants;\n    this.onSendListFolder = new BroadcastEventListener('sendListFolder');\n    this.onUploadFileSolution = new BroadcastEventListener('uploadFileSolution');\n    this.onSendListFile = new BroadcastEventListener('sendListFile');\n    this.checkSelect = false;\n    this.ListFolder = [];\n    this.ListFolderId = [];\n    this.selectedId = '';\n    this.listCodeRule = [];\n    this.ListFile = [];\n    this.solutionModel = {\n      SolutionId: '',\n      FolderId: '',\n      Path: '',\n      ApiUrl: '',\n      FileApiUrl: '',\n      Token: '',\n      DesignType: 0,\n      CurentVersion: 0\n    };\n    this.OldVersionModel = {\n      CurentVersion: 0,\n      EditContent: ''\n    };\n    this.folderModel = {\n      Id: '',\n      Path: '',\n      SelectPath: '',\n      ListFolder: []\n    };\n    this.uploadModel = {\n      ModuleId: '',\n      ListFile: [],\n      DesignType: 0,\n      LstError: [],\n      Status: false\n    };\n    this.searchCodeRuleModel = {\n      Code: ''\n    };\n  }\n\n  ngOnInit() {\n    this.OldVersionModel.CurentVersion = this.curentVersion;\n    this.getFolder();\n    this.signalRService.listen(this.onSendListFolder, false);\n    this.notiSub = this.onSendListFolder.subscribe(data => {\n      this.blockUI.stop();\n\n      if (data) {\n        this.folderModel.ListFolder = data.ListForder;\n\n        if (this.checkSelect) {\n          this.folderModel.SelectPath = data.Path;\n          this.selectPathForder();\n        }\n      }\n    });\n    this.signalRService.listen(this.onSendListFile, false);\n    this.sendListFileSub = this.onSendListFile.subscribe(data => {\n      this.blockUI.stop();\n\n      if (data) {\n        this.ListFile = data;\n      }\n    });\n    this.signalRService.listen(this.onUploadFileSolution, true);\n    this.uploadSolutionSub = this.onUploadFileSolution.subscribe(data => {\n      this.blockUI.stop();\n\n      if (data) {\n        if (data.LstError && data.LstError.length > 0) {\n          var errorMessage = data.LstError.join(\"<br/>\");\n          this.messageService.showMessage(errorMessage);\n        } else {\n          data.Id = this.solutionId;\n          data.CurentVersion = this.OldVersionModel.CurentVersion;\n          data.EditContent = this.OldVersionModel.EditContent;\n          this.solutionService.uploadFileDesignDocument(data).subscribe(data => {\n            this.messageService.showSuccess('Upload tài liệu thiết kế thành công!');\n          }, error => {\n            this.messageService.showError(error);\n          });\n        }\n      }\n    });\n  }\n\n  ngOnDestroy() {\n    this.notiSub.unsubscribe();\n    this.uploadSolutionSub.unsubscribe();\n    this.sendListFileSub.unsubscribe();\n    this.signalRService.stopListening(this.onSendListFolder);\n    this.signalRService.stopListening(this.onUploadFileSolution);\n    this.signalRService.stopListening(this.onSendListFile);\n  }\n\n  getFolder() {\n    this.signalRService.invoke('GetFolder', this.folderModel).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n  getLink(type) {\n    var model = {\n      SolutionId: this.solutionId,\n      Token: '',\n      DesignType: type,\n      ApiUrl: this.config.ServerApi\n    };\n    this.checkSelect = true;\n    let currentUser = JSON.parse(localStorage.getItem('qltkcurrentUser'));\n\n    if (currentUser && currentUser.access_token) {\n      model.Token = currentUser.access_token;\n    }\n\n    this.signalRService.invoke('GetSelectFolderSolution', model).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n  selectPathForder() {\n    var data = this.folderModel.ListFolder.filter(i => i.Id == this.folderModel.SelectPath);\n\n    if (data.length > 0) {\n      this.selectedId = data[0].Id;\n      this.solutionModel.Path = data[0].Id;\n      this.folderModel.Path = data[0].Id;\n      this.treeView.selectedRowKeys = [this.selectedId];\n    }\n  }\n\n  onSelectionChanged(e) {\n    this.selectedId = e.selectedRowKeys[0];\n    this.solutionModel.Path = e.selectedRowKeys[0];\n    this.folderModel.Path = e.selectedRowKeys[0];\n  }\n\n  onRowExpanding(e) {\n    this.checkSelect = false;\n    this.folderModel.Id = e.key;\n    this.signalRService.invoke('GetFolder', this.folderModel).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    }); // this.notiSub = this.onSendListFolder.subscribe((data: any) => {\n    //   this.folderModel.ListFolder = data;\n    // });\n  }\n\n  closeModal() {\n    this.activeModal.close(this.OldVersionModel.CurentVersion);\n  }\n\n  showConfirmUploadVersion() {\n    this.messageService.showConfirmFile(\"Bạn có muốn thay đổi version không?\").then(data => {\n      if (data) {\n        this.showEditContent();\n      } else {\n        this.chooseFolder(this.curentVersion);\n      }\n    });\n  }\n\n  chooseFolder(version) {\n    this.solutionModel.SolutionId = this.solutionId;\n    this.solutionModel.ApiUrl = this.config.ServerApi;\n    this.solutionModel.FileApiUrl = this.config.ServerFileApi;\n    this.solutionModel.CurentVersion = version;\n    let currentUser = JSON.parse(localStorage.getItem('qltkcurrentUser'));\n\n    if (currentUser && currentUser.access_token) {\n      this.solutionModel.Token = currentUser.access_token;\n    }\n\n    this.signalRService.invoke('UploadFileSolutionDesignDocument', this.solutionModel).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n  showEditContent() {\n    let activeModal = this.modalService.open(ShowEditContenComponent, {\n      container: 'body',\n      windowClass: 'show-edit-content-modal',\n      backdrop: 'static'\n    });\n    activeModal.componentInstance.curentVersion = this.curentVersion;\n    activeModal.result.then(result => {\n      this.OldVersionModel = result;\n      this.chooseFolder(result.CurentVersion);\n    }, reason => {});\n  }\n\n  getFile() {\n    this.folderModel.Id = this.selectedId;\n    this.signalRService.invoke('GetListFile', this.folderModel).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n  chooseFile(path) {\n    this.solutionModel.Path = path;\n  }\n\n}\n\nSolutionChooseFileUploadModalComponent.ɵfac = function SolutionChooseFileUploadModalComponent_Factory(t) {\n  return new (t || SolutionChooseFileUploadModalComponent)(i0.ɵɵdirectiveInject(i1.Configuration), i0.ɵɵdirectiveInject(i2.NgbModal), i0.ɵɵdirectiveInject(i3.SignalRService), i0.ɵɵdirectiveInject(i2.NgbActiveModal), i0.ɵɵdirectiveInject(i1.MessageService), i0.ɵɵdirectiveInject(i4.SolutionService), i0.ɵɵdirectiveInject(i1.Constants));\n};\n\nSolutionChooseFileUploadModalComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: SolutionChooseFileUploadModalComponent,\n  selectors: [[\"app-solution-choose-file-upload-modal\"]],\n  viewQuery: function SolutionChooseFileUploadModalComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(DxTreeListComponent, 5);\n    }\n\n    if (rf & 2) {\n      let _t;\n\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.treeView = _t.first);\n    }\n  },\n  decls: 42,\n  vars: 8,\n  consts: [[1, \"modal-header\"], [1, \"modal-title\", \"text-uppercase\", \"text-danger\"], [\"type\", \"button\", \"aria-label\", \"Close\", 1, \"close\", 3, \"click\"], [\"aria-hidden\", \"true\"], [1, \"modal-body\", \"padding-15\", 2, \"height\", \"600px\"], [\"name\", \"form\", \"novalidate\", \"\", 1, \"tab-form-demo\"], [\"f\", \"ngForm\"], [1, \"row\"], [1, \"col-md-12\", \"col-sm-12\", \"col-lg-12\"], [1, \"form-group\"], [1, \"form-label\"], [1, \"controls\"], [\"type\", \"text\", \"name\", \"Pathchoosefolderupload\", \"disabled\", \"\", 1, \"form-control\", 3, \"ngModel\", \"ngModelChange\"], [\"Path\", \"ngModel\"], [1, \"col-md-4\", \"col-sm-4\", \"col-lg-4\"], [\"id\", \"folder\", \"keyExpr\", \"Id\", \"parentIdExpr\", \"ParentId\", \"noDataText\", \" \", \"height\", \"450\", 3, \"dataSource\", \"showRowLines\", \"showBorders\", \"columnAutoWidth\", \"expandedRowKeys\", \"onSelectionChanged\", \"onRowExpanding\", \"click\"], [\"mode\", \"single\"], [\"dataField\", \"Name\", \"caption\", \"Danh s\\u00E1ch th\\u01B0 m\\u1EE5c\"], [1, \"col-md-8\", \"col-sm-8\", \"col-lg-8\"], [2, \"height\", \"500px\", \"; width\", \"100%\", 3, \"config\"], [1, \"table\", \"table-bordered\", 2, \"min-width\", \"200px\"], [\"min-width\", \"200px\", 1, \"text-center\"], [3, \"click\", 4, \"ngFor\", \"ngForOf\"], [1, \"modal-footer\"], [\"type\", \"button\", 1, \"btn\", \"btn-success\", 3, \"click\"], [1, \"fa\", \"fa-save\"], [\"type\", \"button\", 1, \"btn\", \"btn-danger\", 3, \"click\"], [1, \"fa\", \"fa-power-off\"], [3, \"click\"], [\"min-width\", \"200px\"]],\n  template: function SolutionChooseFileUploadModalComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\", 0)(1, \"h4\", 1);\n      i0.ɵɵtext(2, \"Upload t\\u00E0i li\\u1EC7u thi\\u1EBFt k\\u1EBF\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(3, \"button\", 2);\n      i0.ɵɵlistener(\"click\", function SolutionChooseFileUploadModalComponent_Template_button_click_3_listener() {\n        return ctx.closeModal();\n      });\n      i0.ɵɵelementStart(4, \"span\", 3);\n      i0.ɵɵtext(5, \"\\u00D7\");\n      i0.ɵɵelementEnd()()();\n      i0.ɵɵelementStart(6, \"div\", 4)(7, \"form\", 5, 6)(9, \"div\", 7)(10, \"div\", 8)(11, \"div\", 9)(12, \"label\", 10);\n      i0.ɵɵtext(13, \"\\u0110\\u01B0\\u1EDDng d\\u1EABn\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(14, \"div\", 11)(15, \"input\", 12, 13);\n      i0.ɵɵlistener(\"ngModelChange\", function SolutionChooseFileUploadModalComponent_Template_input_ngModelChange_15_listener($event) {\n        return ctx.folderModel.Path = $event;\n      });\n      i0.ɵɵelementEnd()()()()();\n      i0.ɵɵelementStart(17, \"div\", 7)(18, \"div\", 14)(19, \"dx-tree-list\", 15);\n      i0.ɵɵlistener(\"onSelectionChanged\", function SolutionChooseFileUploadModalComponent_Template_dx_tree_list_onSelectionChanged_19_listener($event) {\n        return ctx.onSelectionChanged($event);\n      })(\"onRowExpanding\", function SolutionChooseFileUploadModalComponent_Template_dx_tree_list_onRowExpanding_19_listener($event) {\n        return ctx.onRowExpanding($event);\n      })(\"click\", function SolutionChooseFileUploadModalComponent_Template_dx_tree_list_click_19_listener() {\n        return ctx.getFile();\n      });\n      i0.ɵɵelement(20, \"dxo-selection\", 16)(21, \"dxi-column\", 17);\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(22, \"div\", 18)(23, \"perfect-scrollbar\", 19)(24, \"table\", 20)(25, \"thead\")(26, \"tr\")(27, \"th\", 21);\n      i0.ɵɵtext(28, \"T\\u00EAn file\");\n      i0.ɵɵelementEnd()()();\n      i0.ɵɵelementStart(29, \"tbody\");\n      i0.ɵɵtemplate(30, SolutionChooseFileUploadModalComponent_tr_30_Template, 3, 1, \"tr\", 22);\n      i0.ɵɵelementEnd()()()()()()();\n      i0.ɵɵelementStart(31, \"div\", 23)(32, \"button\", 24);\n      i0.ɵɵlistener(\"click\", function SolutionChooseFileUploadModalComponent_Template_button_click_32_listener() {\n        return ctx.showConfirmUploadVersion();\n      });\n      i0.ɵɵelement(33, \"i\", 25);\n      i0.ɵɵtext(34, \"\\u00A0 \");\n      i0.ɵɵelementStart(35, \"span\");\n      i0.ɵɵtext(36, \"Upload t\\u00E0i li\\u1EC7u\");\n      i0.ɵɵelementEnd()();\n      i0.ɵɵelementStart(37, \"button\", 26);\n      i0.ɵɵlistener(\"click\", function SolutionChooseFileUploadModalComponent_Template_button_click_37_listener() {\n        return ctx.closeModal();\n      });\n      i0.ɵɵelement(38, \"i\", 27);\n      i0.ɵɵtext(39, \" \\u00A0 \");\n      i0.ɵɵelementStart(40, \"span\");\n      i0.ɵɵtext(41, \" \\u0110\\u00F3ng \");\n      i0.ɵɵelementEnd()()();\n    }\n\n    if (rf & 2) {\n      i0.ɵɵadvance(15);\n      i0.ɵɵproperty(\"ngModel\", ctx.folderModel.Path);\n      i0.ɵɵadvance(4);\n      i0.ɵɵproperty(\"dataSource\", ctx.folderModel.ListFolder)(\"showRowLines\", true)(\"showBorders\", true)(\"columnAutoWidth\", true)(\"expandedRowKeys\", ctx.ListFolderId);\n      i0.ɵɵadvance(4);\n      i0.ɵɵproperty(\"config\", ctx.constants.ScrollYConfig);\n      i0.ɵɵadvance(7);\n      i0.ɵɵproperty(\"ngForOf\", ctx.ListFile);\n    }\n  },\n  dependencies: [i5.NgForOf, i6.ɵNgNoValidate, i6.DefaultValueAccessor, i6.NgControlStatus, i6.NgControlStatusGroup, i6.NgModel, i6.NgForm, i7.PerfectScrollbarComponent, i8.DxiColumnComponent, i8.DxoSelectionComponent, i9.DxTreeListComponent],\n  styles: [\".solution-choose-file-upload-modal .modal-dialog{max-width:950px!important;width:950px!important}\\n\"],\n  encapsulation: 2\n});\n\n__decorate([BlockUI()], SolutionChooseFileUploadModalComponent.prototype, \"blockUI\", void 0);","map":null,"metadata":{},"sourceType":"module"}