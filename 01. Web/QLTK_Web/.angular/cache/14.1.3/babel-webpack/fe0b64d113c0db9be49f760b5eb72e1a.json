{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { ElementRef } from '@angular/core';\nimport { BroadcastEventListener } from 'src/app/signalr/broadcast.event.listener';\nimport { TestDesignPopupReportComponent } from '../test-design-popup-report/test-design-popup-report.component';\nimport { BlockUI } from 'ng-block-ui';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/shared\";\nimport * as i2 from \"../services/test-designstructure-service\";\nimport * as i3 from \"src/app/signalR/signal-r.service\";\nimport * as i4 from \"@ng-bootstrap/ng-bootstrap\";\nimport * as i5 from \"../services/test-design-service\";\nconst _c0 = [\"scrollHeaderOne\"];\n\nfunction TestDesignStructureFolderComponent_tr_17_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r5 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"tr\")(1, \"td\", 4);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"td\", 12)(4, \"button\", 13);\n    i0.ɵɵlistener(\"click\", function TestDesignStructureFolderComponent_tr_17_Template_button_click_4_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r5);\n      const i_r3 = restoredCtx.index;\n      const ctx_r4 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r4.download(i_r3 + 1));\n    });\n    i0.ɵɵelement(5, \"span\", 14);\n    i0.ɵɵelementEnd()();\n    i0.ɵɵelementStart(6, \"td\", 15);\n    i0.ɵɵtext(7);\n    i0.ɵɵelementEnd()();\n  }\n\n  if (rf & 2) {\n    const row_r2 = ctx.$implicit;\n    const i_r3 = ctx.index;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(i_r3 + 1);\n    i0.ɵɵadvance(5);\n    i0.ɵɵtextInterpolate(row_r2);\n  }\n}\n\nfunction TestDesignStructureFolderComponent_div_19_span_3_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"span\", 18);\n  }\n}\n\nfunction TestDesignStructureFolderComponent_div_19_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\")(1, \"div\");\n    i0.ɵɵelement(2, \"span\", 16);\n    i0.ɵɵtemplate(3, TestDesignStructureFolderComponent_div_19_span_3_Template, 1, 0, \"span\", 17);\n    i0.ɵɵtext(4);\n    i0.ɵɵelementEnd()();\n  }\n\n  if (rf & 2) {\n    const e_r6 = ctx.$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵproperty(\"ngClass\", e_r6.icon);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", e_r6.items);\n    i0.ɵɵadvance(1);\n    i0.ɵɵtextInterpolate1(\" \", e_r6.text, \" \");\n  }\n}\n\nexport class TestDesignStructureFolderComponent {\n  constructor(constant, config, testDesignStructureService, messageService, signalRService, modalService, testDesignService, componentService) {\n    this.constant = constant;\n    this.config = config;\n    this.testDesignStructureService = testDesignStructureService;\n    this.messageService = messageService;\n    this.signalRService = signalRService;\n    this.modalService = modalService;\n    this.testDesignService = testDesignService;\n    this.componentService = componentService;\n    this.modelTest = {\n      ApiUrl: '',\n      PathFile: '',\n      SelectedPath: '',\n      ModuleCode: '',\n      List3D: [],\n      ListMaterialDB: [],\n      ListModuleDesignDocument: [],\n      ListRawMaterial: [],\n      ListModuleError: [],\n      ListConvertUnit: [],\n      ListDesignStructure: [],\n      ListDesignStructureFile: [],\n      Module: []\n    };\n    this.error = new BroadcastEventListener('listError');\n    this.resultReportNot3d = new BroadcastEventListener('exportReportNot3D');\n    this.exportReportExcel = new BroadcastEventListener('exportExcelTestDesignStructure');\n    this.onDownload = new BroadcastEventListener('downloadFileModuleDesignDocument');\n    this.onDownloadAFile = new BroadcastEventListener('downloadAFile');\n    this.onDeleteList = new BroadcastEventListener('getDeleteList');\n    this.listError = [];\n    this.listErrorMain = [];\n    this.listHeight = 0;\n    this.datatbleCT = [];\n    this.modelReport = {\n      ApiUrl: '',\n      PathDownload: '',\n      PathLocal: '',\n      ModuleCode: '',\n      DatatbleCT: []\n    };\n    this.items = [{\n      Id: 1,\n      text: 'Xóa thư mục, file thừa',\n      icon: 'fas fa-times text-danger'\n    }];\n  }\n\n  ngOnInit() {\n    window.addEventListener('ps-scroll-x', event => {\n      this.scrollHeaderOne.nativeElement.scrollLeft = event.target.scrollLeft;\n    }, true);\n    this.listHeight = window.innerHeight - 390; // this.modelTest.PathFile = this.pathDMVT;\n    // this.modelTest.ModuleCode = this.moduleCode;\n    // this.modelTest.SelectedPath = this.selectedPath;\n    // this.modelTest.ApiUrl = this.config.ServerApi;\n    // this.searchList3D();\n    // this.searchListMaterial();\n    // this.searchListModuleDesignDocument();\n    // this.searchListRawMaterial();\n    // this.searchListModuleErrorNotDone();\n    // this.searchListConvertUnit();\n    // this.searchListDesignStructure();\n    // this.searchListDesignStructureFile();\n\n    this.signalRService.listen(this.error, false);\n    this.signalRService.listen(this.resultReportNot3d, false);\n    this.notiSub = this.resultReportNot3d.subscribe(data => {\n      if (data) {\n        if (data.StatusCode == 1) {\n          this.messageService.showSuccess('Xuất vật tư không có 3D thành công!');\n        } else {\n          this.messageService.showMessage('Xuất vật tư không có 3D không thành công!');\n        }\n      }\n\n      this.blockUI.stop();\n    });\n    this.notiSub = this.error.subscribe(data => {\n      if (data) {\n        if (data.Data) {\n          this.listError = data.Data.listError;\n          this.listErrorMain = data.Data.listErrorMain;\n          this.datatbleCT = data.Data.datatbleCT;\n          this.htmlText = data.Data.htmlText;\n\n          if (this.datatbleCT.length > 0 && this.listErrorMain.length > 0) {\n            this.listError.forEach(error => {\n              this.errorSpecial = this.errorSpecial + error;\n            });\n            this.messageService.showMessageTitle(this.errorSpecial, \"Danh sách lỗi nghiêm trọng\");\n          } else {\n            this.messageService.showMessage(\"Cấu trúc thiết kế \" + this.moduleCode + \" đã chuẩn! Bạn Có thể xem báo cáo?\"); // this.messageService.showSuccess('Đã in báo cáo!');\n          }\n        }\n\n        if (data.StatusCode == 1) {\n          this.messageService.showSuccess(\"Kiểm tra dữ liệu thành công!\");\n        } else {\n          this.messageService.showMessage(data.Message);\n        }\n      }\n\n      this.blockUI.stop();\n    });\n    this.signalRService.listen(this.onDownload, true);\n    this.downloadSub = this.onDownload.subscribe(data => {\n      this.blockUI.stop();\n\n      if (data) {\n        if (data.StatusCode == 2) {\n          this.messageService.showMessage(data.Message);\n        } else {\n          this.messageService.showMessage('Download thành công!');\n        }\n      }\n    }); //\n\n    this.signalRService.listen(this.onDownloadAFile, true);\n    this.downloadAFileSub = this.onDownloadAFile.subscribe(data => {\n      this.blockUI.stop();\n\n      if (data) {\n        if (data.StatusCode == 1) {\n          this.messageService.showMessage('Download thành công!');\n        } else {\n          this.messageService.showMessage(data.Message);\n        }\n      } else {\n        this.messageService.showMessage(data.Message);\n      }\n    }); // this.signalRService.listen(this.onDeleteList, true);\n    // this.deleteList = this.onDeleteList.subscribe((data: any) => {\n    //   this.blockUI.stop();\n    //   if (data) {\n    //     //this.check();\n    //     this.messageService.showSuccess('Xóa file thành công!');\n    //   }\n    // });\n  }\n\n  ngOnDestroy() {\n    window.removeEventListener('ps-scroll-x', null);\n    this.downloadSub.unsubscribe();\n    this.signalRService.stopListening(this.onDownload);\n    this.downloadAFileSub.unsubscribe();\n    this.signalRService.stopListening(this.onDownloadAFile); //this.deleteList.unsubscribe();\n    //this.signalRService.stopListening(this.onDeleteList);\n  }\n\n  exportExcel() {\n    this.testDesignService.exportReportTestDesignStructure({\n      ModuleCode: this.moduleCode,\n      DatatbleCT: this.datatbleCT\n    }).subscribe(d => {\n      this.modelReport.ApiUrl = this.config.ServerApi;\n      this.modelReport.PathDownload = d;\n      this.modelReport.ModuleCode = this.moduleCode;\n      this.signalRService.invoke('ExportExcelReportDesignStructure', this.modelReport).subscribe(data => {\n        if (data) {\n          this.blockUI.start();\n        } else {\n          this.messageService.showMessage(\"Không kết nối được service\");\n        }\n      });\n    }, e => {\n      this.messageService.showError(e);\n    });\n  }\n\n  showReport() {\n    let activeModal = this.modalService.open(TestDesignPopupReportComponent, {\n      container: 'body',\n      windowClass: 'test-design-popup-report-modal',\n      backdrop: 'static'\n    });\n    activeModal.componentInstance.htmlText = this.htmlText;\n  }\n\n  viewReportNot3D() {\n    let isExistNot3d = false;\n\n    for (var i = 0; i < this.datatbleCT.length; i++) {\n      if (this.datatbleCT[i].Type == \"Không có trong thư viện 3D\") {\n        isExistNot3d = true;\n        i = this.datatbleCT.length - 1;\n      }\n    }\n\n    if (isExistNot3d) {\n      this.modelReport.DatatbleCT = this.datatbleCT.filter(element => {\n        return element.Type == \"Không có trong thư viện 3D\";\n      });\n\n      if (this.modelReport.DatatbleCT.length > 0) {\n        this.modelReport.ModuleCode = this.moduleCode;\n        this.signalRService.invoke('ExportReportNot3D', this.modelReport).subscribe(data => {\n          if (data) {\n            this.blockUI.start();\n          } else {\n            this.messageService.showMessage(\"Không kết nối được service\");\n          }\n        });\n      } else {\n        this.messageService.showMessage('Không có vật tư không có 3D!');\n      }\n    } else {\n      this.messageService.showMessage(\"Không có vật tư cần xuất!\");\n    }\n  }\n\n  showChooseFolderWindow(isExcel) {\n    this.componentService.showChooseFolder(0, 0, '').subscribe(result => {\n      if (result) {\n        this.modelReport.PathLocal = result;\n\n        if (!isExcel) {\n          this.viewReportNot3D();\n        } else {\n          this.exportExcel();\n        }\n      }\n    }, reason => {});\n  }\n\n  getListErrorDesignStructure() {\n    this.modelTest.ModuleCode = this.moduleCode;\n    this.modelTest.PathFile = this.pathDMVT;\n    this.modelTest.SelectedPath = this.selectedPath;\n    this.modelTest.ApiUrl = this.config.ServerApi;\n    let currentUser = JSON.parse(localStorage.getItem('qltkcurrentUser'));\n\n    if (currentUser && currentUser.access_token) {\n      this.modelTest.Token = currentUser.access_token;\n    }\n\n    this.signalRService.invoke('GetListErrorDesignStructure', this.modelTest).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n  searchList3D() {\n    this.testDesignStructureService.searchDesign().subscribe(data => {\n      if (data) {\n        this.modelTest.List3D = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchListMaterial() {\n    this.testDesignStructureService.searchMaterial().subscribe(data => {\n      if (data) {\n        this.modelTest.ListMaterialDB = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchListModuleDesignDocument() {\n    this.testDesignStructureService.searchListModuleDesignDocument().subscribe(data => {\n      if (data) {\n        this.modelTest.ListModuleDesignDocument = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchListRawMaterial() {\n    this.testDesignStructureService.searchRawMaterial().subscribe(data => {\n      if (data) {\n        this.modelTest.ListRawMaterial = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchListModuleErrorNotDone() {\n    this.testDesignStructureService.searchListModuleErrorNotDone().subscribe(data => {\n      if (data) {\n        this.modelTest.ListModuleError = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchListConvertUnit() {\n    this.testDesignStructureService.searchListConvertUnit().subscribe(data => {\n      if (data) {\n        this.modelTest.ListConvertUnit = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchListDesignStructure() {\n    this.testDesignStructureService.searchListDesignStructure().subscribe(data => {\n      if (data) {\n        this.modelTest.ListDesignStructure = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchListDesignStructureFile() {\n    this.testDesignStructureService.searchListDesignStructureFile().subscribe(data => {\n      if (data) {\n        this.modelTest.ListDesignStructureFile = data;\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  searchModule() {\n    this.testDesignStructureService.searchModule(this.moduleCode).subscribe(data => {\n      if (data) {\n        this.modelTest.Module.push(data);\n        this.getListErrorDesignStructure();\n      }\n    }, error => {\n      this.messageService.showError(error);\n    });\n  }\n\n  download(index) {\n    var data = this.listErrorDownload.filter(i => i.Index == index);\n\n    if (data.length > 0) {\n      if (data[0].Type == 1) {\n        this.downloadAFile(data[0]);\n      } else if (data[0].Type == 2) {\n        this.downloadFile(index, data[0].FileName, data[0].FilePath);\n      }\n    } else {\n      this.messageService.showMessage(\"Bạn chỉ có thể download file khác size\");\n    }\n  }\n\n  downloadAFile(data) {\n    var file = {\n      FileName: data.FileName,\n      PathFileMaterial: data.FilePath,\n      Token: '',\n      ApiUrl: this.config.ServerApi,\n      FileApiUrl: this.config.ServerFileApi\n    };\n    let currentUser = JSON.parse(localStorage.getItem('qltkcurrentUser'));\n\n    if (currentUser && currentUser.access_token) {\n      file.Token = currentUser.access_token;\n    }\n\n    this.signalRService.invoke('DownloadFile3DMaterial', file).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n  downloadFile(id, name, serverPath) {\n    var file = {\n      Id: id,\n      Token: '',\n      Type: 1,\n      FilePath: serverPath,\n      ModuleCode: this.moduleCode,\n      ListDocumentFileSize: this.listDocumentFileSize,\n      ApiUrl: this.config.ServerApi\n    };\n    let currentUser = JSON.parse(localStorage.getItem('qltkcurrentUser'));\n\n    if (currentUser && currentUser.access_token) {\n      file.Token = currentUser.access_token;\n    }\n\n    this.signalRService.invoke('DownloadFileModuleDocument', file).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n  itemClick(e) {\n    if (e.itemData.Id == 1) {\n      this.deleteLists();\n    }\n  }\n\n  deleteLists() {\n    this.signalRService.invoke('DeleteListFileFolder', this.listFileRedundant).subscribe(data => {\n      if (data) {\n        this.blockUI.start();\n      } else {\n        this.messageService.showMessage(\"Không kết nối được service\");\n      }\n    });\n  }\n\n}\n\nTestDesignStructureFolderComponent.ɵfac = function TestDesignStructureFolderComponent_Factory(t) {\n  return new (t || TestDesignStructureFolderComponent)(i0.ɵɵdirectiveInject(i1.Constants), i0.ɵɵdirectiveInject(i1.Configuration), i0.ɵɵdirectiveInject(i2.TestDesignStructureService), i0.ɵɵdirectiveInject(i1.MessageService), i0.ɵɵdirectiveInject(i3.SignalRService), i0.ɵɵdirectiveInject(i4.NgbModal), i0.ɵɵdirectiveInject(i5.TestDesignService), i0.ɵɵdirectiveInject(i1.ComponentService));\n};\n\nTestDesignStructureFolderComponent.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: TestDesignStructureFolderComponent,\n  selectors: [[\"app-test-design-structure-folder\"]],\n  viewQuery: function TestDesignStructureFolderComponent_Query(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵviewQuery(_c0, 5);\n    }\n\n    if (rf & 2) {\n      let _t;\n\n      i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.scrollHeaderOne = _t.first);\n    }\n  },\n  inputs: {\n    pathDMVT: \"pathDMVT\",\n    moduleCode: \"moduleCode\",\n    txtPathSC: \"txtPathSC\",\n    selectedPath: \"selectedPath\",\n    listErrorDesignFolder: \"listErrorDesignFolder\",\n    listErrorDownload: \"listErrorDownload\",\n    listFileRedundant: \"listFileRedundant\",\n    listDocumentFileSize: \"listDocumentFileSize\"\n  },\n  decls: 20,\n  vars: 5,\n  consts: [[1, \"row\"], [1, \"col-md-12\", \"col-sm-12\", \"col-lg-12\", \"col-lg-12\", \"col-xl-12\"], [1, \"form-label\"], [1, \"table\", \"table-bordered\", \"mb-0\", 2, \"min-width\", \"650px\"], [\"width\", \"100px\", 1, \"text-center\"], [\"width\", \"80px\", 1, \"text-center\"], [\"min-width\", \"300px\", 1, \"text-center\"], [\"id\", \"fileRedundant\", 2, \"height\", \"500px\", 3, \"config\"], [1, \"table\", \"table-bordered\", 2, \"min-width\", \"650px\"], [4, \"ngFor\", \"ngForOf\"], [\"keyExpr\", \"Id\", \"target\", \"#fileRedundant\", 3, \"dataSource\", \"width\", \"onItemClick\"], [4, \"dxTemplate\", \"dxTemplateOf\"], [\"width\", \"80px\", 2, \"text-align\", \"center\"], [\"type\", \"button\", \"placement\", \"bottom\", \"ngbTooltip\", \"Download file\", \"container\", \"body\", 1, \"btn\", \"btn-xs\", \"btn-info\", 3, \"click\"], [\"aria-hidden\", \"true\", 1, \"fas\", \"fa-arrow-down\"], [\"min-width\", \"300px\"], [3, \"ngClass\"], [\"class\", \"dx-icon-spinright\", 4, \"ngIf\"], [1, \"dx-icon-spinright\"]],\n  template: function TestDesignStructureFolderComponent_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\", 0)(1, \"div\", 1)(2, \"label\", 2);\n      i0.ɵɵtext(3, \"Danh s\\u00E1ch l\\u1ED7i c\\u1EA5u tr\\u00FAc thi\\u1EBFt k\\u1EBF \");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementContainerStart(4);\n      i0.ɵɵelementStart(5, \"table\", 3)(6, \"thead\")(7, \"tr\")(8, \"th\", 4);\n      i0.ɵɵtext(9, \"STT\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(10, \"th\", 5);\n      i0.ɵɵtext(11, \"X\\u1EED l\\u00FD\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(12, \"th\", 6);\n      i0.ɵɵtext(13, \"T\\u00EAn l\\u1ED7i\");\n      i0.ɵɵelementEnd()()()();\n      i0.ɵɵelementStart(14, \"perfect-scrollbar\", 7)(15, \"table\", 8)(16, \"tbody\");\n      i0.ɵɵtemplate(17, TestDesignStructureFolderComponent_tr_17_Template, 8, 2, \"tr\", 9);\n      i0.ɵɵelementEnd()()();\n      i0.ɵɵelementStart(18, \"dx-context-menu\", 10);\n      i0.ɵɵlistener(\"onItemClick\", function TestDesignStructureFolderComponent_Template_dx_context_menu_onItemClick_18_listener($event) {\n        return ctx.itemClick($event);\n      });\n      i0.ɵɵtemplate(19, TestDesignStructureFolderComponent_div_19_Template, 5, 3, \"div\", 11);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementContainerEnd();\n      i0.ɵɵelementEnd()();\n    }\n\n    if (rf & 2) {\n      i0.ɵɵadvance(14);\n      i0.ɵɵproperty(\"config\", ctx.constant.ScrollYConfig);\n      i0.ɵɵadvance(3);\n      i0.ɵɵproperty(\"ngForOf\", ctx.listErrorDesignFolder);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"dataSource\", ctx.items)(\"width\", 200);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"dxTemplateOf\", \"item\");\n    }\n  }\n});\n\n__decorate([BlockUI()], TestDesignStructureFolderComponent.prototype, \"blockUI\", void 0);","map":null,"metadata":{},"sourceType":"module"}