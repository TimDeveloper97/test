{"ast":null,"code":"/**\r\n * DevExtreme (esm/ui/tree_list/ui.tree_list.editing.js)\r\n * Version: 22.1.4\r\n * Build date: Fri Jul 22 2022\r\n *\r\n * Copyright (c) 2012 - 2022 Developer Express Inc. ALL RIGHTS RESERVED\r\n * Read about DevExtreme licensing here: https://js.devexpress.com/Licensing/\r\n */\nimport \"./ui.tree_list.editor_factory\";\nimport $ from \"../../core/renderer\";\nimport errors from \"../widget/ui.errors\";\nimport { isDefined } from \"../../core/utils/type\";\nimport { extend } from \"../../core/utils/extend\";\nimport { Deferred } from \"../../core/utils/deferred\";\nimport messageLocalization from \"../../localization/message\";\nimport treeListCore from \"./ui.tree_list.core\";\nimport gridCoreUtils from \"../grid_core/ui.grid_core.utils\";\nimport { editingModule } from \"../grid_core/ui.grid_core.editing\";\nvar TREELIST_EXPAND_ICON_CONTAINER_CLASS = \"dx-treelist-icon-container\";\nvar SELECT_CHECKBOX_CLASS = \"dx-select-checkbox\";\nvar DATA_EDIT_DATA_INSERT_TYPE = \"insert\";\nvar EditingController = editingModule.controllers.editing.inherit({\n  _generateNewItem: function (key) {\n    var item = this.callBase(key);\n    item.data = {\n      key: key\n    };\n    item.children = [];\n    item.level = 0;\n    item.parentKey = this.option(\"rootValue\");\n    return item;\n  },\n  _isProcessedItem: function () {\n    return true;\n  },\n  _setInsertAfterOrBeforeKey: function (change, parentKey) {\n    if (void 0 !== parentKey && parentKey !== this.option(\"rootValue\")) {\n      change.insertAfterKey = parentKey;\n    } else {\n      this.callBase.apply(this, arguments);\n    }\n  },\n  _getLoadedRowIndex: function (items, change) {\n    var dataController = this.getController(\"data\");\n    var dataSourceAdapter = dataController.dataSource();\n    var parentKey = null === dataSourceAdapter || void 0 === dataSourceAdapter ? void 0 : dataSourceAdapter.parentKeyOf(change.data);\n\n    if (void 0 !== parentKey && parentKey !== this.option(\"rootValue\")) {\n      var rowIndex = gridCoreUtils.getIndexByKey(parentKey, items);\n\n      if (rowIndex >= 0 && this._dataController.isRowExpanded(parentKey)) {\n        return rowIndex + 1;\n      }\n\n      return -1;\n    }\n\n    return this.callBase.apply(this, arguments);\n  },\n  _isEditColumnVisible: function () {\n    var result = this.callBase.apply(this, arguments);\n    var editingOptions = this.option(\"editing\");\n    return result || editingOptions.allowAdding;\n  },\n  _isDefaultButtonVisible: function (button, options) {\n    var result = this.callBase.apply(this, arguments);\n    var row = options.row;\n\n    if (\"add\" === button.name) {\n      return this.allowAdding(options) && row.rowIndex !== this._getVisibleEditRowIndex() && !(row.removed || row.isNewRow);\n    }\n\n    return result;\n  },\n  _getEditingButtons: function (options) {\n    var buttons = this.callBase.apply(this, arguments);\n\n    if (!options.column.buttons) {\n      buttons.unshift(this._getButtonConfig(\"add\", options));\n    }\n\n    return buttons;\n  },\n  _beforeSaveEditData: function (change) {\n    var dataController = this._dataController;\n    var result = this.callBase.apply(this, arguments);\n\n    if (change && change.type !== DATA_EDIT_DATA_INSERT_TYPE) {\n      var store = null === dataController || void 0 === dataController ? void 0 : dataController.store();\n      var key = null === store || void 0 === store ? void 0 : store.key();\n\n      if (!isDefined(key)) {\n        throw errors.Error(\"E1045\");\n      }\n    }\n\n    return result;\n  },\n  addRowByRowIndex: function (rowIndex) {\n    var dataController = this.getController(\"data\");\n    var row = dataController.getVisibleRows()[rowIndex];\n    return this.addRow(row ? row.key : void 0);\n  },\n  addRow: function (key) {\n    if (void 0 === key) {\n      key = this.option(\"rootValue\");\n    }\n\n    return this.callBase.call(this, key);\n  },\n  _addRowCore: function (data, parentKey, oldEditRowIndex) {\n    var callBase = this.callBase;\n    var rootValue = this.option(\"rootValue\");\n    var dataController = this.getController(\"data\");\n    var dataSourceAdapter = dataController.dataSource();\n    var parentKeyGetter = dataSourceAdapter.createParentIdGetter();\n    parentKey = parentKeyGetter(data);\n\n    if (void 0 !== parentKey && parentKey !== rootValue && !dataController.isRowExpanded(parentKey)) {\n      var deferred = new Deferred();\n      dataController.expandRow(parentKey).done(() => {\n        setTimeout(() => {\n          callBase.call(this, data, parentKey, oldEditRowIndex).done(deferred.resolve).fail(deferred.reject);\n        });\n      }).fail(deferred.reject);\n      return deferred.promise();\n    }\n\n    return callBase.call(this, data, parentKey, oldEditRowIndex);\n  },\n  _initNewRow: function (options, parentKey) {\n    var dataController = this.getController(\"data\");\n    var dataSourceAdapter = dataController.dataSource();\n    var parentIdSetter = dataSourceAdapter.createParentIdSetter();\n    parentIdSetter(options.data, parentKey);\n    return this.callBase.apply(this, arguments);\n  },\n  allowAdding: function (options) {\n    return this._allowEditAction(\"allowAdding\", options);\n  },\n  _needToCloseEditableCell: function ($targetElement) {\n    return this.callBase.apply(this, arguments) || $targetElement.closest(\".\" + TREELIST_EXPAND_ICON_CONTAINER_CLASS).length && this.isEditing();\n  },\n\n  getButtonLocalizationNames() {\n    var names = this.callBase.apply(this);\n    names.add = \"dxTreeList-editingAddRowToNode\";\n    return names;\n  }\n\n});\nvar originalRowClick = editingModule.extenders.views.rowsView._rowClick;\nvar originalRowDblClick = editingModule.extenders.views.rowsView._rowDblClick;\n\nvar validateClick = function (e) {\n  var $targetElement = $(e.event.target);\n  var originalClickHandler = \"dxdblclick\" === e.event.type ? originalRowDblClick : originalRowClick;\n\n  if ($targetElement.closest(\".\" + SELECT_CHECKBOX_CLASS).length) {\n    return false;\n  }\n\n  return !needToCallOriginalClickHandler.call(this, e, originalClickHandler);\n};\n\nfunction needToCallOriginalClickHandler(e, originalClickHandler) {\n  var $targetElement = $(e.event.target);\n\n  if (!$targetElement.closest(\".\" + TREELIST_EXPAND_ICON_CONTAINER_CLASS).length) {\n    originalClickHandler.call(this, e);\n    return true;\n  }\n\n  return false;\n}\n\nvar RowsViewExtender = extend({}, editingModule.extenders.views.rowsView, {\n  _renderCellCommandContent: function ($container, options) {\n    var editingController = this._editingController;\n    var isEditRow = options.row && editingController.isEditRow(options.row.rowIndex);\n    var isEditing = options.isEditing || isEditRow;\n\n    if (!isEditing) {\n      return this.callBase.apply(this, arguments);\n    }\n\n    return false;\n  },\n  _rowClick: function (e) {\n    if (validateClick.call(this, e)) {\n      this.callBase.apply(this, arguments);\n    }\n  },\n  _rowDblClick: function (e) {\n    if (validateClick.call(this, e)) {\n      this.callBase.apply(this, arguments);\n    }\n  }\n});\ntreeListCore.registerModule(\"editing\", {\n  defaultOptions: function () {\n    return extend(true, editingModule.defaultOptions(), {\n      editing: {\n        texts: {\n          addRowToNode: messageLocalization.format(\"dxTreeList-editingAddRowToNode\")\n        }\n      }\n    });\n  },\n  controllers: {\n    editing: EditingController\n  },\n  extenders: {\n    controllers: extend(true, {}, editingModule.extenders.controllers, {\n      data: {\n        changeRowExpand: function () {\n          this._editingController.refresh();\n\n          return this.callBase.apply(this, arguments);\n        }\n      }\n    }),\n    views: {\n      rowsView: RowsViewExtender,\n      headerPanel: editingModule.extenders.views.headerPanel\n    }\n  }\n});","map":null,"metadata":{},"sourceType":"module"}